#!/usr/bin/env groovy
def currentStage = ""

def HOTFIX_PERFROMANCE_TESTS = ["TCPNetworkPerformance_Multiclient", "TCPNetworkPerformance_SingleClient", "Storage4K", "Storage1024K", "NVME4K", "UDPNetworkPerformance_Multiclient", "PERF-SYSCALL-BENCHMARK" ]
def TCPNetwork1Tests = "PERF-NETWORK-TCP-THROUGHPUT-MULTICLIENTS-NTTTCP-Synthetic,PERF-NETWORK-TCP-THROUGHPUT-MULTICLIENTS-NTTTCP-SRIOV"
def TCPNetwork2Tests = "PERF-NETWORK-TCP-LATENCY-Synthetic,PERF-NETWORK-TCP-LATENCY-SRIOV,PERF-NETWORK-TCP-SINGLE-CONNECTION-THROUGHPUT-SYNTHETIC,PERF-NETWORK-TCP-SINGLE-CONNECTION-THROUGHPUT-SRIOV"
def UDPNetworkTests = "PERF-NETWORK-UDP-1K-THROUGHPUT-MULTICONNECTION-NTTTCP-Synthetic,PERF-NETWORK-UDP-1K-THROUGHPUT-MULTICONNECTION-NTTTCP-SRIOV"
def PERFORMANCE_TESTS = ["${TCPNetwork1Tests}", "${TCPNetwork2Tests}","PERF-STORAGE-4K-IO","PERF-STORAGE-1024K-IO", "PERF-NVME-4K-IO", "${UDPNetworkTests}", "PERF-SYSCALL-BENCHMARK" ]
def TEST_REGIONS = ["westus2", "westus2", "westus2", "northeurope", "westus2", "westus2", "westus2" ]
def total_tests = HOTFIX_PERFROMANCE_TESTS.size()

def armImagesCentOS = ["rhel_6.5": "OpenLogic CentOS 6.5 Latest", "rhel_6.6": "OpenLogic CentOS 6.6 Latest", "rhel_6.7": "OpenLogic CentOS 6.7 Latest",
				 "rhel_6.8": "OpenLogic CentOS 6.8 Latest", "rhel_6.9": "OpenLogic CentOS 6.9 Latest", "rhel_6.10": "OpenLogic CentOS 6.10 Latest",
				 "rhel_7.0": "OpenLogic CentOS 7.0 Latest", "rhel_7.1": "OpenLogic CentOS 7.1 Latest", "rhel_7.2": "OpenLogic CentOS 7.2 Latest",
				 "rhel_7.3": "OpenLogic CentOS 7.3 Latest", "rhel_7.4": "OpenLogic CentOS 7.4 Latest", "rhel_7.5": "OpenLogic CentOS 7.5 Latest",
				 "rhel_7.6": "OpenLogic CentOS 7.6 Latest"]
def armImagesRHEL = ["rhel_6.5": "NA", "rhel_6.6": "NA", "rhel_6.7": "RedHat RHEL 6.7 Latest",
				 "rhel_6.8": "RedHat RHEL 6.8 Latest", "rhel_6.9": "RedHat RHEL 6.9 Latest", "rhel_6.10": "RedHat RHEL 6.10 Latest",
				 "rhel_7.0": "NA", "rhel_7.1": "NA", "rhel_7.2": "RedHat RHEL 7.2 Latest",
				 "rhel_7.3": "RedHat RHEL 7.3 Latest", "rhel_7.4": "RedHat RHEL 7.4 Latest", "rhel_7.5": "RedHat RHEL 7.5 Latest",
				 "rhel_7.6": "RedHat RHEL 7-RAW 7.6.2018103108"]
def armImagesOracle = ["rhel_6.5": "NA", "rhel_6.6": "NA", "rhel_6.7": "NA",
				 "rhel_6.8": "Oracle Oracle-Linux 6.8 Latest", "rhel_6.9": "Oracle Oracle-Linux 6.9 Latest", "rhel_6.10": "Oracle Oracle-Linux 6.10 Latest",
				 "rhel_7.0": "NA", "rhel_7.1": "NA", "rhel_7.2": "NA",
				 "rhel_7.3": "Oracle Oracle-Linux 7.3 Latest", "rhel_7.4": "Oracle Oracle-Linux 7.4 Latest", "rhel_7.5": "Oracle Oracle-Linux 7.5 Latest",
				 "rhel_7.6": "Oracle Oracle-Linux 7.6 Latest"]

def RunPowershellCommand(psCmd) {
    bat "powershell.exe -NonInteractive -ExecutionPolicy Bypass -Command \"[Console]::OutputEncoding=[System.Text.Encoding]::UTF8;$psCmd;EXIT \$global:LastExitCode\""
    //println "powershell.exe -NonInteractive -ExecutionPolicy Bypass -Command \"[Console]::OutputEncoding=[System.Text.Encoding]::UTF8;$psCmd;EXIT \$global:LastExitCode\""
}

def CleanWorkspace() {
    retry(5) {
        cleanWs()
    }
}

def Prepare() {
    retry(5) {
        cleanWs()
        unstash 'LISAv2'
    }
}

def ReportException(stagename, exc) {
	def body = "<pre>"
	body += "\nStage Name        : ${stagename}\n"
	body += "\nException Message : ${exc}\n"
	body += "\nBuild URL         : ${env.BUILD_URL}\n"
	withCredentials([string(credentialsId: 'HOTFIX_DEV_MAIL', variable: 'HOTFIX_DEV_MAIL')]) {
	emailext (
		subject: "JOB: ${env.JOB_NAME} BUILD:${env.BUILD_NUMBER} Exception",
		to: "${env.HOTFIX_DEV_MAIL}",
		mimeType : "text/html",
		body: body
		)
	}
}

currentStage = "Prerequisites"
stage ("${currentStage}") {
     node ("meta_slave") {
         cleanWs()
         git branch: env.GIT_BRANCH, url: env.GIT_REPO
         stash includes: '**', name: 'LISAv2'
         cleanWs()
     }
}

def stageTimeout = 90
currentStage = "Copy Image"
stage ("${currentStage}") {
	println "Copy Image ${LIS_VHD} in other regions"
	node ("azure") {
		try {
			timeout(time: stageTimeout, unit: 'MINUTES') {
				node('azure') {
					CleanWorkspace()
					withCredentials([file(credentialsId: 'Azure_Secrets_TESTONLY_File', variable: 'Azure_Secrets_TESTONLY_File')]) {
						Prepare()
						//Demo command is to set the environment in Jenkin working directory
						def Command = ".\\Run-LisaV2.ps1"
							Command += " -XMLSecretFile ${Azure_Secrets_TESTONLY_File}"
							Command += " -TestPlatform 'Azure'"
							Command += " -RGIdentifier 'DEMO'"
							Command += " -TestLocation centralus"
							Command += " -ARMImageName 'Canonical UbuntuServer 16.04-LTS latest'"
							Command += " -TestCategory 'Functional'"
							Command += " -TestArea 'CORE'"
							Command += " -TestNames 'DEMO-TEST'"
							Command += " -ResourceCleanup Delete"
							Command += " -TestIterations 1"
							Command += " -ExitWithZero"
						println "Copy VHD to other storage"
						RunPowershellCommand(".\\Utilities\\AddAzureRmAccountFromSecretsFile.ps1 -customSecretsFilePath ${Azure_Secrets_TESTONLY_File};" +
							"${Command};" +
							".\\Utilities\\CopyVHDtoOtherStorageAccount.ps1" +
							" -sourceLocation 'westus2'" +
							" -destinationLocations 'westus2,northeurope,southcentralus'" +
							" -sourceVHDName '${LIS_VHD}'" +
							" -destinationVHDName '${LIS_VHD}'"
						)
					}
				}
			}
		}
		catch (exc) {
			currentBuild.result = 'FAILURE'
			println "${currentStage}: STAGE_FAILED_EXCEPTION."
			ReportException("${currentStage}", "${exc}")
		}
	}
}

node ("azure") {
	currentStage = "PerformanceTests"
	def parellel_jobs = [:]
	stage ("${currentStage}") {
		for (i=0; i < total_tests; i++) {
			def currentTestCounter = i
			def currentTest = HOTFIX_PERFROMANCE_TESTS[currentTestCounter]
			def perfTest = PERFORMANCE_TESTS[currentTestCounter]
			def testLocation = TEST_REGIONS[currentTestCounter]
			if (currentTest != null && currentTest != "" ) {
				def delay = 0
				currentTest = "${currentTest}"
				parellel_jobs ["${currentTest}"] =
				{
					stage ("${currentTest}") {
						try {
							node ("azure") {
								delay += 5
								println "Sleeping ${delay} seconds..."
								sleep "${delay}"
								withCredentials([file(credentialsId: 'Azure_Secrets_TESTONLY_File', variable: 'Azure_Secrets_TESTONLY_File')]) {
									println "Current Performance Test ${currentTest} "
									println "Test to run  ${perfTest} "
									Prepare()
									def Command = ".\\Run-LisaV2.ps1"
									Command += " -XMLSecretFile ${Azure_Secrets_TESTONLY_File}"
									Command += " -TestPlatform 'Azure'"
									Command += " -RGIdentifier 'RPMBUILD-${BUILD_NUMBER}'"
									Command += " -TestCategory 'Performance'"
									Command += " -TestNames '${perfTest}'"
									Command += " -StorageAccount 'ExistingStorage_Standard'"
									Command += " -CustomTestParameters 'LIS_OLD_URL=${LISoldurl};LIS_CURRENT_URL=${rpmURL}'"
									Command += " -ResultDBTestTag '${ExecutionTag}'"
									Command += " -DeployVMPerEachTest 1"
									Command += " -ExitWithZero"
									Command += " -EnableTelemetry"
									Command += " -TestIterations 3"
									Command += " -OsVHD '${LIS_VHD}'"
									println "Test Location: ${testLocation}"
									Command += " -TestLocation '${testLocation}'"
									println Command
									RunPowershellCommand(Command)
									junit "Report\\*-junit.xml"
									println "Archieving the report of Performance Tests"
									archiveArtifacts('Report\\*-junit.xml')
									archiveArtifacts '*-TestLogs.zip'
								}
							}
						}
						catch (exc) {
							currentBuild.result = 'SUCCESS'
							println exc
							ReportException("${currentTest}", "${exc}")
						}
					}
				}
			}
		}
	parallel parellel_jobs
	}
}
